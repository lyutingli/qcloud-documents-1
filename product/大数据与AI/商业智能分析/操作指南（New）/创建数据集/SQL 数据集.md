各种实体以及实体之间的各种联系均可用关系模型来表示。关系模型就是指二维表格模型，因而一个关系型数据库就是由二维表及其之间的联系组成的一个数据组织。关系数据库是建立在关系模型基础上的数据库，借助于集合代数等数学概念和方法来处理数据库中的数据，是目前数据库存储类型中的常用类型。当前主流的关系型数据库有 Oracle、SQL Server、MySQL、PostgreSQL、Hive、Spark 等。

标准数据查询语言 SQL 是一种介于关系代数与关系演算之间的结构化查询语言，包括查询、操纵、定义和控制，是一个通用的、功能极强的关系型数据库语言，同时又是一种高度非过程化的语言，只要求用户指出做什么而不需要指出怎么做。SQL 集成实现了数据库生命周期中的全部操作， 提供了与关系数据库进行交互的方法，它可以与标准的编程语言一起工作。

SQL 数据集主要是通过 JDBC 和 ODBC 与目前主流数据库相联系。 JDBC 和 ODBC 提供了一组对数据库访问的标准 API，建立了一组数据库访问的规范，支持 SQL 语句的执行，同时也是 腾讯云商业智能分析BI 与数据源之间的主要接口。 腾讯云商业智能分析BI 对数据库的操作不依赖任何 DBMS，不直接与 DBMS 打交道，所有的数据库操作由对应的 DBMS 的数据库驱动程序完成。

## 创建 SQL 数据集
1. 登录 [BI 控制台](https://console.cloud.tencent.com/bi) 主页面。
![](https://main.qcloudimg.com/raw/79e0c3bf79a7b95ee4fe0902cd050ad9.png)
2. 通过以下两种方式进入创建 SQL 数据集界面：
 - 单击导航栏 >【创建数据集】，在新打开的页面上选择【SQL 数据集】。
 - 如果您有已打开的数据集界面，单击菜单栏 >【创建数据集】>【SQL 数据集】。
 
3.  用户在数据集界面上，单击菜单栏上的新建按钮，选择 SQL 数据集，即可打开 SQL 数据集界面。
![](https://main.qcloudimg.com/raw/038190d0de46c5c34a8187fb33eb08fb.png)
 也可以单击首页上的 SQL 数据集，进入 SQL 数据集新建界面。
 
## 使用存储过程创建 SQL 数据集
SQL 存储过程（Stored Procedure）是一组为了完成特定功能的 SQL 语句集，经编译后存储在数据库中。用户通过指定存储过程的名字来执行它。存储过程是数据库中的一个重要对象，任何一个设计良好的数据库应用程序都应该用到存储过程。

对于不带参数的数据库中存储过程的语法如下：
```
create procedure uui
as
select * from student
go
```
然后在产品的 SQL 语句中写的语句为`{Call mydb.dbo.uui ()}`。此时没有任何的参数需要配置，刷新元数据就能预览出数据了。目前不支持带参的存储过程。

## SQL 数据集特例（企业版功能）
### 数据集经纬度数据
SQL 语句支持对经纬度数据的查询。经度的范围是：0-180 度，负数表示西经，正数表示东经；纬度的范围是：0-90 度，负数表示南纬，正数表示北纬。可以通过给定经度值和纬度值查找到给定圆或矩形范围内的数据。

例如：`select * from "GIS.sqry" where pos incircle (-83.2215,42.1407, 200)` 表示：数据集表 GIS 中，经度值为：-83.2215，纬度值为：42.1407，半径为 200 米的圆形范围内的数据。通过 SQL 语句查询经纬度数据需要使用永洪的驱动。

列 pos 表示中心点的位置。它是通过特定的算法将经度和纬度结合在一起。使用前需要在数据集 GIS 中通过增加表达式的方式来增加 pos 列。创建表达式界面截图如下所示：
![](https://main.qcloudimg.com/raw/c0e3596f6d1f13606e8a33a28b8b6683.png)
参数 incircle 表示在圆形范围内查询。需要输入：经度值、纬度值、半径（米）。
参数 inrect 表示在矩形范围内查询。需要输入：经度值、纬度值、宽（米）和高（米）。

使用 SQL 语句对经纬度数据进行查询的截图如下所示：
![](https://main.qcloudimg.com/raw/15c3436b6fa2dbfc12fbb87f19b56d30.png)

## 性能检测
用户使用 SQL 数据集时，系统会对数据集性能进行实时检测，并对影响性能的地方做出橙色标识，告知用户哪些列为什么没有下推到数据库执行，如下图所示：
![](https://main.qcloudimg.com/raw/0f2898994dfc6b23e0bd5f4747ffbd34.png)
用户也可以通过单击菜单删的“检测性能”，查看所有性能问题。
![](https://main.qcloudimg.com/raw/429cfcadc4c4da15733c6027c86bac26.png)

## 数据治理
创建数据集之后，刷新元数据，可对元数据进行一系列数据清洗、治理操作，如：转换为数字列（企业版）、转换为日期列（企业版）、转换为维度列、转换为度量列、设置文件夹（企业版）、设置数据层次（企业版）、设置日期层次（企业版）、设置数据范围（企业版）、设置表达式（企业版）、设置日期表达式、为字段设置别名、设置数据权限（企业版）。

### 转换为度量列
您可通过两种方式可以将维度字段转为度量字段：
- 通过拖拽的方式，即选中维度字段拖动鼠标将字段从维度区域拖拽到度量区域。
- 在元数据区选中维度字段单击“更多”图标，菜单中选择转换为度量列。

![](https://main.qcloudimg.com/raw/7501a214a0cc86dfb2078cc2a458d67e.png)
![](https://main.qcloudimg.com/raw/a280f6179ad22ec6a53b9d8cc0af978a.png)
转换后该列存放在度量区域。
![](https://main.qcloudimg.com/raw/035e9883734e65a4acf6fbd22d5e6466.png)

### 转换为维度列
您可通过两种方式可以将度量字段转为维度字段：
- 通过拖拽的方式，即选中度量字段拖动鼠标将字段从度量区域拖拽到维度区域。
- 选中度量字段单击“更多”图标，菜单中选择转换为维度列。

![](https://main.qcloudimg.com/raw/cb108207d06bd387b974b72afe84180f.png)
![](https://main.qcloudimg.com/raw/f469199153d6085a7bf6653cbeb39cf4.png)
转换后该列存放在维度区域。
![](https://main.qcloudimg.com/raw/642de99e3715385c28023f55b2cc4f48.png)

### 转换为日期列
您可以将字符串和长整数两种类型的字段转换为日期列。在元数据上选中字段或者在细节数据选中字段的列头单击“更多”图标，菜单中选择转换为日期列选项，同样在元数据或细节数据中单击“更多”图标可以编辑或者删除新转化的列。
1. 在字符串类型的字段上单击更多图标，菜单选择转换为日期列，打开转换为日期列对话框，如图：
![](https://main.qcloudimg.com/raw/e46e8f5b49ae62a066626f6bfe1a5753.png)
【原始字段】需要转换为日期列的字段。
【列名】日期列名称，默认名称是 “ 日期列 ”，可以对名称进行修改。
【日期】根据列数据选择相应的格式。例如数据为 2016-01-23，选择的格式应该为 yyyy-MM-dd。
2. 在长整数类型的列上单击更多图标，菜单选择转换为日期列，打开转换为日期列对话框，如图：
![](https://main.qcloudimg.com/raw/823dd7643c7340c41e009ee0abf4f46b.png)
【原始字段】需要转换为日期列的字段。
【名称】日期列名称，默认名称是 “ 日期列 ”。修改列名，单击确定后，根据相应的公式，把数据转化为日期。
例如：
原始数据如图：
![](https://main.qcloudimg.com/raw/3e2691e824ec3e646f112ea8d8c3ec20.png)
将 “ 字符串 ” 列转换为日期列 “ 日期列 1”，格式为 “yyyy.MM.dd” ；将 “ 长整数 ” 转换为日期列 “ 日期列2”。转化后数据如下：
![](https://main.qcloudimg.com/raw/53cebc5fbf30705f6e795565b1c0c6af.png)
新建生成日期列后，会自动选中该列，如果有纵向滚动条会滑动到新列的位置并选中新列。
在已创建的日期列上点更多图标，可对其进行编辑、删除。


### 转换为数据列
您可以将字符串类型的字段转换为数字列，在元数据上选中字段，单击“更多”图标，菜单中选择选择转换为数字列选项，同样在元数据中单击更多图标可以编辑或者删除新转化的列。
在字符串类型的字段上单击更多图标，菜单中选择转换为数字列，打开转换为数字列对话框，如图：
![](https://main.qcloudimg.com/raw/11a9dee623cbfa38f5b9295e6a7c489a.png)
【原始字段】需要转换为数字列的字段。
【名称】数字列名称，默认名称是 “ 数字列 ”，可以对名称进行修改。
【数字 & 货币 & 百分比】根据列数据选择相应的格式。例如数据为 20%，选择的格式应该为百分比。


例如：
原始数据如图：
![](https://main.qcloudimg.com/raw/dceb28526f53d96a729a416f663664ee.png)
将 “ 百分比字符串 ” 转化为数字列 “ 百分比 ”，格式选择 “ 百分比 ” ；将 “ 浮点数字符串 ” 转换为 “ 浮点数 ”，格式选择 “#,##0.##”。预览数据如图：
![](https://main.qcloudimg.com/raw/9050a91288d225805d1385496dfaba51.png)
新建生成数字列后，会自动选中该列，如果有纵向滚动条会滑动到新列的位置并选中新列。
在已创建的数字列上单击更多图标，可对其进行编辑、删除。


### 设置文件夹
用户可以在数据集编辑界面创建文件夹，按照需求将字段拖拽到文件夹中，便于对字段进行分类。也可以在维度或度量中多选列右键新建文件夹，将多个字段同时放在文件及下。通过维度和度量字段创建的文件夹分别对应存放在维度区域和度量区域。当字段较多时，通过创建文件夹可以使界面看起来更有层次感，展示起来更清晰。

例如：
某一 SQL 数据集中存在 BUDGET_COGS，BUDGET_MARGIN，BUDGET_PROFIT，BUDGET_SALES 这四个与预算相关的字段，如下图所示 ：
![](https://main.qcloudimg.com/raw/d6f169575958688a198de6f9707bcfdd.png)
用户在元数据区域按Ctrl键同时选中这几列，然后右键选择新建文件夹，如下图所示 ：
![](https://main.qcloudimg.com/raw/79ee583610b7d0a7a3a33ca4634b6adf.png)
在弹出的对话框中，中文环境下会默认名称是 “ 文件夹 ”，修改文件夹名称，单击确定按钮则在元数据区域生成文件夹。
![](https://main.qcloudimg.com/raw/a5c152966094de104b0ee797c7e253e5.png)
确定后，相应字段便会自动放到文件夹中，如下图所示：
![](https://main.qcloudimg.com/raw/4eaba65b7ead809069919ee4ef9d416f.png)
被拖拽到文件夹中的字段不可以通过鼠标的拖拽来调节位置。

### 设置数据量
预览细节数据时，预览行数默认是 1000 行，可以根据需要修改预览行数，修改后可单击页面空白处或按键盘 Enter 键进行应用。
例如：将查询中预览行数设为 5，应用后数据中只显示 5 条数据。
![](https://main.qcloudimg.com/raw/5ccd24a4f6482710a0002ff442a6f7b4.png)

### 查看细节数据
单击预览数据集，用户可查看数据集的细节数据，也可以单击数据集列表上预览数据集图标进行查看，详情可参考附录->界面介绍->数据集界面部分。
![](https://main.qcloudimg.com/raw/db4b64f87527a3a5e110ca52e0f49de6.png)

### 设置数据层次
维度的范围有大小的概念，例如国家的范围大，省的范围次之，城市的范围更小。可以把范围的大小的概念称之为层次。在维度节点下建立层次目录，把有范围大小的维度通过拖拽放入层次中。范围大的放在最上面，范围小的维度放在下面。维度的顺序，决定了钻取的顺序。当需要上钻时，会找到与当前维度最近的上一个维度（即范围大点的维度）。当需要下钻时，会找到与当前维度最近的下一个维度（即范围小点的维度）。

例如：
某一 SQL 数据集中存在年、季度、月份字段，三个字段之间有范围大小的概念，年大于季度，季度大于月份，如下图所示。
![](https://main.qcloudimg.com/raw/5d88826d964bee75666972f4f99db8a3.png)

用户在元数据区域同时选中列“年”、“季度”、“月份”，右键选择增加层次，如下图所示。
![](https://main.qcloudimg.com/raw/220371645023d8baef989aabf70a3f57.png)
在弹出的对话框中，中文环境下会默认名称是 “ 层次 ”，可以修改层次名称，单击确定按钮则在元数据区域生成层次。
![](https://main.qcloudimg.com/raw/31709eaaa1c906b9798ba550743f808f.png)
被拖拽到层次文件夹中的字段仍可通过鼠标的拖拽来调节位置。在上的字段范围较大，如下图所示。
![](https://main.qcloudimg.com/raw/6abc79d4d670d470a4cfaf7f1268bc19.png)
当用户在报告编辑区中绑定该层次文件夹中的字段时，会在范围较大的数据段的左侧生成加号，当用户单击此加号时，比当前数据段的范围小一级的数据段将被自动绑定，同时加号变成减号。
![](https://main.qcloudimg.com/raw/e4e29d837d5a48d1d906d7f5c8487f9c.png)

### 设置日期层次
用户可在日期、时间、时间戳类型的数据段上单击更多图标，选择新建日期层次，来创建用户数据段。
![](https://main.qcloudimg.com/raw/f726ee2c7efdd2083925a0e25be2b72c.png)
打开的日期型层次对话框如下图所示。会默认名称是 “ 日期层次 ”，用户根据需要修改日期型层次的名称，以及勾选需要创建的日期型列。
对于元数据中已经存在的日期列在对话框中是勾选状态，并且是灰色字体、不可编辑。
![](https://main.qcloudimg.com/raw/a2f0d0b9b1e055e6eeaac2f69cc3f339.png)
日期是一个典型的层次结构。当选择了某一日期字段时，可以给该字段建立一个层次，并选择需要建立的日期维度。支持的日期维度如下表所示。

| 日期唯独 | 数据类型 | 说明 |
|---------|---------|---------|
| 年季度	| Timestamp	| 季度，把所有本季度的，映射到本季度的第一天|
| 年月	| Timestamp	| 月份，把所有本月的，映射到本月第一天 |
| 年周	|Timestamp	|周，把所有本周的，映射到本周第一天|
| 天	| Timestamp	| 日，把所有本天的，映射到本天零点|
|小时|	Timestamp	|小时，把所有本小时的，映射到该小时的起点|
|五分钟	|Timestamp	|五分钟，把所有本五分钟的，映射到该五分钟的起点|
|分钟	|Timestamp|	分，把所有本分钟的，映射到该分钟的起点|
|秒|	Timestamp	|秒，把所有本秒的，映射到该秒的起点|
|年	|Integer	|年份|
|季度_年|	Integer	|季度，1-4|
|月_年	|Integer	|月份,1-12|
|周_年	|Integer	|每年得第几个星期，1-52周|
|天_年	|Integer|	日，每月的第几日，1-31|
|天_周|	Integer	|每个星期的第几天|
|小时_天	|Integer	|小时，0-23|
|分钟_小时|	Integer	|分，0-59|
|秒_分钟|	Integer	|秒，0-59|

年季度、年月、年周、天、小时、五分钟、分钟、秒，均把相应的日期、时间、时间戳数据段映射成时间戳类型。年、季度 _ 年、月 _ 年、周 _ 年、天 _ 年、天 _ 周、小时 _ 天、分钟 _ 小时、秒 _ 分钟则把日期、时间、时间戳数据段映射成整数类型。

例如：一时间戳类型数据为 2012-11-02 11:34:25，进行映射后的数据如下表所示。
| 映射前的数据 | 映射后的数据 |
|-------|--------|
|年季度	|2012-10-01 00:00:00|
|年月	|2012-11-01 00:00:00|
|年周	|2012-10-28 00:00:00|
|天|	2012-11-02 00:00:00|
|小时	|2012-11-02 11:00:00|
|五分钟|	2012-11-02 11:30:00|
|分钟	|2012-11-02 11:34:00|
|秒	|2012-11-02 11:34:25|
|年|	2012|
|季度_年|	4|
|月_年|	11|
|周_年|	44|
|天_年|	2|
|天_周|	6|
|小时_天|	11|
|分钟_小时|	34|
|秒_分钟|	25|

在已创建的日期型层次上单击更多图标，可对其进行重命名、删除。

### 设置数据范围
数据范围是给一个数字类型字段创建一个划分范围的维度字段。因此，此字段会自动列入维度的节点下。可以在元数据界面上，选择一个数字类型字段，单击更多图标选择新建数据范围，如下图所示：
![](https://main.qcloudimg.com/raw/af676557dd66589d3abdc0ad2bd3d79e.png)
也可以在细节数据界面，选择一个数字类型字段列头，单击更多图标选择新建数据范围。
![](https://main.qcloudimg.com/raw/665636269bd38a56645c5263bbc4bc74.png)
在打开的对话框中，用户可修改数据范围的名称、类型、边界、最小值、最大值、步长。
![](https://main.qcloudimg.com/raw/a363172b448ee5cb9ac63c733c96b67f.png)
【原始字段】创建数据范围所使用的字段。
【名称】数据范围的列名，默认名称是 “ 数据范围 ”。
类型为范围：
【最小值】设定数据范围的最小值。
【最大值】设定数据范围的最大值。
【步长】设定数据范围的步长值。
【包含小于最小值的范围】当用户不勾选时，则小于最小值的值将被映射成空。当勾选上时，小于最小值的值将被映射成最小值减去步长值。
【包含大于最大值的范围】当用户不勾选时，则大于最大值的值将被映射成空。当勾选上时，大于最大值的值将被映射成最大值加上步长值。
【包含范围的左边界不包含右边界】数据范围包含左边界但不包含右边界。
【不包含范围的左边界包含右边界】数据范围包含右边界但不包含左边界。
类型为分组：
【定义刻度】定义刻度值。
【添加】将定义的刻度添加进去。
【删除】将已添加的刻度删除掉。
【标签】可以给添加的刻度范围设置别名。

例如：
假设对成绩列增加数字范围，该数字范围的最小值为 60，步长值为 10，最大值为 100，包含小于最小值的范围，不包含范围的左边界包含右边界，如下图所示。
![](https://main.qcloudimg.com/raw/85ce1a7d777dbf1af23b300ee517f577.png)
在表上的映射结果如下图所示。因为勾选了 “ 包含小于最小值的范围 ” 所以小于 60 的成绩被映射成50。勾选了 “ 不包含范围的左边界包含右边界 ”，所以 70 映射成了 60，否则被映射成 70。

| 成绩 | 数字范围 |
| ----- | ----- |
| 55	|50|
|60	|50|
|65	|60|
|70	|60|
|78	|70|
|80|	70|
|82|	80|
|90	|80|
|95	|90|
|100|	90|

新建生成数据范围列后，会自动选中该列，如果有纵向滚动条会滑动到新列的位置并选中新列。
在已创建的数据范围数据段上单击更多图标，可对其进行编辑、删除。

### 设置表达式
表达式是指在数据集编辑界面，创建新的表达式字段。作用域是当前数据集，所有使用该数据集的报表都能使用此字段。在元数据界面上选中列或者在细节数据界面上单击“更多”图标选择新建表达式，并输入表达式名称，选择数据类型，并编辑脚本语言来返回结果。脚本中不能使用聚合函数。创建后，可以通过拖拽，放到维度结点下或者度量结点下。

例如：SQL&JS 表达式
在元数据区中存在下图中的字段，用户需要创建一个利润字段，该字段的计算方式为销售总额字段减去成本。
![](https://main.qcloudimg.com/raw/a308661fdb155e54d3bfcdb09fdaaa45.png)
在元数据区域单击更多图标选择新建表达式，如下图所示。
![](https://main.qcloudimg.com/raw/b802e88b40e6caf0e91adcf7e60aef6d.png)
在细节数据界面，选中列的列头，单击更多图标选择新建表达式。
![](https://main.qcloudimg.com/raw/72b32fe3001410425df1fead7f4589dc.png)
在弹出的表达式对话框中默认名称是 “ 表达式 ”，修改名称，数据类型以及输入脚本进行计算，可通过 SQL 或者 JS 两种方式运行，以 JS 为例。
![](https://main.qcloudimg.com/raw/dfd2d9b8375ca306ad087cc03f40e446.png)
单击确定按钮后，将在元数据区生成利润字段。
用户在编辑数据库数据集时，如果使用 JS 脚本，会影响数据集性能。产品的实时性能检测机制，会标识出性能不佳的地方。用户也可以通过【检测性能】按钮，查看所有性能问题。
![](https://main.qcloudimg.com/raw/a8c0dc2e61752c250bc882dbc8a67373.png)

新建生成表达式列后，会自动选中该列，如果有纵向滚动条会滑动到新列的位置并选中新列。
在已创建的表达式上单击更多图标，可对其进行编辑、删除。



### 设置日期表达式
元数据中在日期，时间，时间戳类型的字段上单击更多图标，或者在细节数据界面选中日期，时间，时间戳类型字段的列头单击“更多”图标，菜单中选择新建日期表达式。表达式对话框如图：
![](https://main.qcloudimg.com/raw/afce21829a4053bb34fb412ea65ba808.png)
新建生成日期表达式后，会自动选中该列（如果生成多个则只选中第一个），如果有纵向滚动条会滑动到新列的位置并选中新列。
在已创建的日期表达式上单击更多图标，可对其进行删除。这里不再赘述，详细信息请参看本章的日期层次。

### 为字段设置别名
元数据中选中某列，单击别名，可以为该列设置别名。也可以在细节数据界面，选择某列的列头，单击更多图标选择别名来设置。


### 控制列权限
列控制包含可见性与列过滤，为不同用户分配不同数据列的查看权限。对维度列设置不可见，在报告中查看时，在组件中会根据隐藏后其它列重新进行计算。
在数据集的元数据，可以对数据集中列的可见和列过滤器进行设置，如下图所示：
![](https://main.qcloudimg.com/raw/416b3eeea9a0487062e48883c1699d86.png)
![](https://main.qcloudimg.com/raw/fbc5610bb034f369e0df794fd8388eb8.png)
#### 可见性
【可见性】数据集中的列默认为可见状态的，当单击某一列的 “ 可见 ” 按钮后，该列在元数据区则会立即不可见。
![](https://main.qcloudimg.com/raw/4d75d6dd7d285776f7f5d2c8b032f5ff.png)
【显示隐藏列】勾选上“显示隐藏列”，【可见性】设置了不可见的列则会显示出来，显示成灰色， “可见 ” 按钮上会显示一条向右的斜线，表示此列为不可见，再次单击一下这个按钮该列就可见了。
![](https://main.qcloudimg.com/raw/3d57abe99da5ae8805d58abb81944cdd.png)

#### 列过滤器
【列过滤器】在管理系统 - 认证授权 - 安全管理下设置文件权限后，在数据集的元数据区域会显示列过滤器的操作项。列过滤器可以对用户和组设置不可见的权限。
当鼠标单击数据列与列过滤器的交叉处时，将会显示提示文字：编辑，单击编辑，则会弹出列过滤器对话框，如下图所示。
![](https://main.qcloudimg.com/raw/31de732c82538041d58673b21b5326da.png)
【可选列表】列出了所有可以被设置权限的用户和组。只有具备 admin_role 和 groupAdmin_role 的用户才可以设置列权限。对于 admin_role 的用户 , 可用列表会列出所有的用户，组和角色。对于 groupAdmin_role 的用户，只列出 groupAdmin_role 下的所有用户和组。
【已选列表】添加到已选列表中用户或组在查看报告中不能看到所编辑的列。比如：对 product 列进行列过滤器编辑，将 user1 添加到已选列表中，确定。再用 user1 登录后，在编辑报告中都不能看到 product 列。
【添加】将可用列表中的用户添加到已选列表中。
【移除】将可用列表中的用户移除。

#### 可见与列过滤器的关系
在可见的状态下，可以对用户，组和角色设置列过滤器。设置后，所设置的用户，角色和组对设置列不可见而其他的用户，组和角色不受影响。
在不可见的状态下，列过滤器的对话框为置灰状态的。不能对列过滤器进行编辑。对度量列设置不可见后如果在组件中已绑定该列，打开组件后不会对绑定产生影响，但组件中不会显示该列。









